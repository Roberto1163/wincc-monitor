<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de Energia - 192.168.0.100</title>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #bbbbbb;
            font-size: 1.1rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #4caf50;
            box-shadow: 0 0 8px #4caf50;
            animation: pulse 2s infinite;
        }
        
        .status-dot.error {
            background-color: #f44336;
            box-shadow: 0 0 8px #f44336;
            animation: none;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .last-update {
            color: #aaaaaa;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab:hover {
            background: rgba(40, 40, 60, 0.9);
            transform: translateY(-2px);
        }
        
        .tab.active {
            background: rgba(79, 195, 247, 0.2);
            border-color: #4fc3f7;
            color: #4fc3f7;
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.2);
        }
        
        .content {
            display: none;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 500px;
        }
        
        .content.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .section-title {
            color: #4fc3f7;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(79, 195, 247, 0.3);
            font-size: 1.5rem;
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .data-card {
            background: rgba(20, 20, 35, 0.8);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s;
        }
        
        .data-card:hover {
            transform: translateY(-3px);
            border-color: rgba(79, 195, 247, 0.4);
        }
        
        .card-title {
            color: #bbbbbb;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .card-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .card-min-max {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #aaaaaa;
        }
        
        .min-value {
            color: #ff9800;
        }
        
        .max-value {
            color: #4caf50;
        }
        
        .unit {
            color: #4fc3f7;
            font-size: 0.9rem;
            margin-left: 5px;
        }
        
        .alert {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #ffcdd2;
        }
        
        .alert-title {
            color: #f44336;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-icon {
            font-size: 1.2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            overflow: hidden;
        }
        
        th {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid rgba(79, 195, 247, 0.3);
        }
        
        td {
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .null-value {
            color: #757575;
            font-style: italic;
        }
        
        .zero-value {
            color: #ff9800;
            font-weight: bold;
        }
        
        .warning {
            color: #ff9800;
            font-weight: bold;
        }
        
        .critical {
            color: #f44336;
            font-weight: bold;
        }
        
        .tariff-active {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #777777;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #4fc3f7;
        }
        
        .spinner {
            border: 4px solid rgba(79, 195, 247, 0.3);
            border-top: 4px solid #4fc3f7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
        }
        
        .chart-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #aaaaaa;
        }
        
        .chart-legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .energy-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .energy-card {
            background: rgba(20, 20, 35, 0.8);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }
        
        .energy-card h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .energy-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffffff;
            margin: 10px 0;
        }
        
        .energy-label {
            color: #bbbbbb;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .energy-tariff-tables {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .tariff-table {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
        }
        
        .tariff-table h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tariff-badge {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .energy-tariff-tables {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Monitoramento de Energia El√©trica</h1>
            <p class="subtitle">Dispositivo: 192.168.0.100 | Atualiza√ß√£o autom√°tica a cada 15 segundos</p>
        </header>
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Conectado</span>
            </div>
            <div class="last-update">
                √öltima atualiza√ß√£o: <span id="lastUpdate">--</span>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="extreme">Valores Extremos</div>
            <div class="tab" data-tab="instant">Valores Instant√¢neos</div>
            <div class="tab" data-tab="charts">Gr√°ficos</div>
            <div class="tab" data-tab="energy">Energia</div>
            <div class="tab" data-tab="alerts">Alertas</div>
        </div>
        
        <div id="extreme" class="content active">
            <h2 class="section-title">üìä Valores Extremos (M√°ximos e M√≠nimos)</h2>
            <div id="extremeContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando dados...</p>
                </div>
            </div>
        </div>
        
        <div id="instant" class="content">
            <h2 class="section-title">üìà Valores Instant√¢neos</h2>
            <div id="instantContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando dados...</p>
                </div>
            </div>
        </div>
        
        <div id="charts" class="content">
            <h2 class="section-title">üìâ Gr√°ficos em Tempo Real</h2>
            <div class="chart-info">
                <p>Atualiza√ß√£o autom√°tica a cada 15 segundos</p>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f44336;"></div>
                        <span>Fase 1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #4caf50;"></div>
                        <span>Fase 2</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2196f3;"></div>
                        <span>Fase 3</span>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="voltageChart"></canvas>
            </div>
            
            <div class="chart-container">
                <canvas id="powerChart"></canvas>
            </div>
        </div>
        
        <div id="energy" class="content">
            <h2 class="section-title">üîã Medi√ß√£o de Energia (Contador)</h2>
            <div id="energyContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando dados do contador...</p>
                </div>
            </div>
        </div>
        
        <div id="alerts" class="content">
            <h2 class="section-title">‚ö†Ô∏è Alertas e Anomalias</h2>
            <div id="alertsContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analisando dados...</p>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Sistema de Monitoramento de Energia | Step 3.5 Flash | Dados obtidos de: 192.168.0.100</p>
            <p style="margin-top: 5px; font-size: 0.8rem;">Nota: O dispositivo mostra data de 2023 - verifique o rel√≥gio interno!</p>
        </footer>
    </div>

    <script>
        // Configura√ß√µes
        const BASE_URL = "http://192.168.0.100/data.json";
        const UPDATE_INTERVAL = 15000; // 15 segundos
        const MAX_DATA_POINTS = 30; // N√∫mero m√°ximo de pontos no gr√°fico (30 * 15s = 7.5 minutos)
        
        // Elementos DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const lastUpdateSpan = document.getElementById('lastUpdate');
        const extremeContent = document.getElementById('extremeContent');
        const instantContent = document.getElementById('instantContent');
        const energyContent = document.getElementById('energyContent');
        const alertsContent = document.getElementById('alertsContent');
        
        // Vari√°veis para gr√°ficos
        let voltageChart, powerChart;
        let voltageData = {
            labels: [],
            datasets: [
                { 
                    label: 'V_L1 (V)', 
                    data: [], 
                    borderColor: '#f44336', 
                    backgroundColor: 'rgba(244, 67, 54, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                { 
                    label: 'V_L2 (V)', 
                    data: [], 
                    borderColor: '#4caf50', 
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                { 
                    label: 'V_L3 (V)', 
                    data: [], 
                    borderColor: '#2196f3', 
                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        };
        let powerData = {
            labels: [],
            datasets: [
                { 
                    label: 'P_SUM (kW)', 
                    data: [], 
                    borderColor: '#ff9800', 
                    backgroundColor: 'rgba(255, 152, 0, 0.2)',
                    tension: 0.3,
                    fill: true
                }
            ]
        };
        
        // Configurar tema escuro para Chart.js
        Chart.defaults.color = '#e0e0e0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.plugins.tooltip = {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#4fc3f7',
            bodyColor: '#e0e0e0',
            borderColor: 'rgba(79, 195, 247, 0.3)',
            borderWidth: 1,
            padding: 10,
            displayColors: true
        };
        Chart.defaults.plugins.legend = {
            labels: {
                color: '#e0e0e0',
                padding: 15,
                font: {
                    size: 12
                }
            }
        };
        
        // Fun√ß√£o para alternar abas
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        // Fun√ß√£o para formatar data/hora
        function formatDateTime(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Fun√ß√£o para extrair valor num√©rico de um objeto (para gr√°ficos)
        function getValue(obj, key) {
            if (!obj || obj[key] === undefined) return null;
            const val = obj[key];
            if (typeof val === 'object' && val !== null && 'value' in val) {
                return val.value;
            }
            if (typeof val === 'object' && val !== null && 'total' in val) {
                return val.total;
            }
            return val; // assume que √© n√∫mero direto
        }
        
        // Fun√ß√£o para criar cart√£o de dados (suporta ambos formatos)
        function createDataCard(key, data) {
            if (data === null) {
                return `<div class="data-card"><div class="card-title">${key}</div><div class="card-value null-value">N/A</div></div>`;
            }
            
            let value, max, min, unit, valueClass;
            
            // Formato instant√¢neo (value, unit)
            if (data.value !== undefined) {
                value = data.value;
                unit = data.unit || '';
                return `
                    <div class="data-card">
                        <div class="card-title">${key}</div>
                        <div class="card-value">${value} <span class="unit">${unit}</span></div>
                    </div>
                `;
            } 
            // Formato extremo (max, min, unit)
            else if (data.max !== undefined) {
                max = data.max;
                min = data.min;
                unit = data.unit || '';
                value = max;
                valueClass = (max === 0 && min === 0) ? 'zero-value' : '';
                return `
                    <div class="data-card">
                        <div class="card-title">${key}</div>
                        <div class="card-value ${valueClass}">${max} <span class="unit">${unit}</span></div>
                        <div class="card-min-max">
                            <span class="min-value">Min: ${min}</span>
                            <span class="max-value">Max: ${max}</span>
                        </div>
                    </div>
                `;
            }
            // Formato contador (total, unit)
            else if (data.total !== undefined) {
                value = data.total;
                unit = data.unit || '';
                return `
                    <div class="data-card">
                        <div class="card-title">${key}</div>
                        <div class="card-value">${value} <span class="unit">${unit}</span></div>
                    </div>
                `;
            } else {
                return `<div class="data-card"><div class="card-title">${key}</div><div class="card-value null-value">N/A</div></div>`;
            }
        }
        
        // Fun√ß√£o para processar dados EXTREME_VALUES
        function processExtremeData(data) {
            if (!data || !data.EXTREME_VALUES) {
                return '<div class="alert">Dados inv√°lidos ou indispon√≠veis</div>';
            }
            
            const ev = data.EXTREME_VALUES;
            const localTime = ev.LOCAL_TIME || '--';
            
            // Separar dados importantes para exibi√ß√£o em cards
            const importantKeys = [
                'V_L1', 'V_L2', 'V_L3', 'V_LN_AVG',
                'I_L1', 'I_L2', 'I_L3', 'I_AVG',
                'P_SUM', 'VA_SUM', 'PF_SUM',
                'FREQ', 'THDV_L1', 'THDV_L2', 'THDV_L3'
            ];
            
            let cardsHtml = '<div class="data-grid">';
            importantKeys.forEach(key => {
                if (ev[key] !== undefined) {
                    cardsHtml += createDataCard(key, ev[key]);
                }
            });
            cardsHtml += '</div>';
            
            // Tabela completa
            let tableHtml = `
                <p><strong>Hor√°rio do dispositivo:</strong> ${formatDateTime(localTime)}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Par√¢metro</th>
                            <th>M√°ximo</th>
                            <th>M√≠nimo</th>
                            <th>Unidade</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(ev).sort().forEach(key => {
                if (key !== 'LOCAL_TIME') {
                    const val = ev[key];
                    if (val === null) {
                        tableHtml += `
                            <tr>
                                <td>${key}</td>
                                <td colspan="3" class="null-value">N/A</td>
                            </tr>
                        `;
                    } else if (typeof val === 'object' && val.max !== undefined) {
                        tableHtml += `
                            <tr>
                                <td>${key}</td>
                                <td>${val.max}</td>
                                <td>${val.min}</td>
                                <td>${val.unit}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            tableHtml += '</tbody></table>';
            
            return cardsHtml + tableHtml;
        }
        
        // Fun√ß√£o para processar dados INST_VALUES
        function processInstantData(data) {
            if (!data || !data.INST_VALUES) {
                return '<div class="alert">Dados inv√°lidos ou indispon√≠veis</div>';
            }
            
            const iv = data.INST_VALUES;
            const localTime = iv.LOCAL_TIME || '--';
            
            // Cards com valores importantes
            let cardsHtml = '<div class="data-grid">';
            const importantKeys = [
                'V_L1', 'V_L2', 'V_L3',
                'I_L1', 'I_L2', 'I_L3',
                'P_SUM', 'VA_SUM', 'PF_SUM',
                'FREQ', 'THDV_L1'
            ];
            
            importantKeys.forEach(key => {
                if (iv[key] !== undefined) {
                    cardsHtml += createDataCard(key, iv[key]);
                }
            });
            cardsHtml += '</div>';
            
            // Tabela completa
            let tableHtml = `
                <p><strong>Hor√°rio do dispositivo:</strong> ${formatDateTime(localTime)}</p>
                <table>
                    <thead>
                        <tr>
                            <th>Par√¢metro</th>
                            <th>Valor Atual</th>
                            <th>Unidade</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.keys(iv).sort().forEach(key => {
                if (key !== 'LOCAL_TIME') {
                    const val = iv[key];
                    if (val === null) {
                        tableHtml += `
                            <tr>
                                <td>${key}</td>
                                <td colspan="2" class="null-value">N/A</td>
                            </tr>
                        `;
                    } else if (typeof val === 'object' && val.value !== undefined) {
                        tableHtml += `
                            <tr>
                                <td>${key}</td>
                                <td>${val.value}</td>
                                <td>${val.unit}</td>
                            </tr>
                        `;
                    }
                }
            });
            
            tableHtml += '</tbody></table>';
            
            return cardsHtml + tableHtml;
        }
        
        // Fun√ß√£o para processar dados COUNTER (nova aba de energia)
        function processCounterData(data) {
            if (!data || !data.COUNTER) {
                return '<div class="alert">Dados do contador indispon√≠veis</div>';
            }
            
            const counter = data.COUNTER;
            const localTime = counter.LOCAL_TIME || '--';
            const actualTariff = counter.ACTUAL_TARIFF || 'N/A';
            
            // Extrair dados de energia
            const activeEnergy = counter.ACTIVE_ENERGY || {};
            const reactiveEnergy = counter.REACTIVE_ENERGY || {};
            const apparentEnergy = counter.APPARENT_ENERGY || {};
            
            // Fun√ß√£o para obter valor por tarifa
            function getTariffValue(obj, tariff, type) {
                if (!obj || !obj[type] || !obj[type][tariff] || obj[type][tariff].total === undefined) {
                    return { value: 0, unit: obj.unit || '' };
                }
                return {
                    value: obj[type][tariff].total,
                    unit: obj.unit || ''
                };
            }
            
            // Calcular totais
            let totalActiveImport = 0, totalActiveExport = 0;
            let totalReactiveImport = 0, totalReactiveExport = 0;
            let totalApparent = 0;
            
            ['T1', 'T2'].forEach(tariff => {
                const activeImport = getTariffValue(activeEnergy, tariff, 'IMPORT');
                const activeExport = getTariffValue(activeEnergy, tariff, 'EXPORT');
                const reactiveImport = getTariffValue(reactiveEnergy, tariff, 'IMPORT');
                const reactiveExport = getTariffValue(reactiveEnergy, tariff, 'EXPORT');
                const apparent = getTariffValue(apparentEnergy, tariff, 'NET');
                
                totalActiveImport += activeImport.value;
                totalActiveExport += activeExport.value;
                totalReactiveImport += reactiveImport.value;
                totalReactiveExport += reactiveExport.value;
                totalApparent += apparent.value;
            });
            
            // HTML para resumo
            let html = `
                <div class="energy-summary">
                    <div class="energy-card">
                        <h3>Hora Local</h3>
                        <div class="energy-value">${formatDateTime(localTime).split(' ')[1]}</div>
                        <div class="energy-label">${localTime ? formatDateTime(localTime).split(' ')[0] : '--'}</div>
                    </div>
                    <div class="energy-card">
                        <h3>Tarifa Ativa</h3>
                        <div class="energy-value">${actualTariff}</div>
                        <div class="energy-label">${actualTariff === 'T1' ? 'Ponta' : 'Fora de Ponta'}</div>
                    </div>
                    <div class="energy-card">
                        <h3>Energia Ativa Total</h3>
                        <div class="energy-value">${totalActiveImport - totalActiveExport} <span style="font-size:1.5rem">kWh</span></div>
                        <div class="energy-label">Import - Export</div>
                    </div>
                    <div class="energy-card">
                        <h3>Energia Reativa Total</h3>
                        <div class="energy-value">${totalReactiveImport - totalReactiveExport} <span style="font-size:1.5rem">kvarh</span></div>
                        <div class="energy-label">Import - Export</div>
                    </div>
                </div>
            `;
            
            // Tabelas por tarifa
            html += `
                <div class="energy-tariff-tables">
                    <div class="tariff-table">
                        <h3>Tarifa 1 (Ponta) ${actualTariff === 'T1' ? '<span class="tariff-active">ATIVA</span>' : ''}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Valor (kWh/kvarh/kVAh)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Energia Ativa Import</td>
                                    <td>${getTariffValue(activeEnergy, 'T1', 'IMPORT').value.toFixed(2)} kWh</td>
                                </tr>
                                <tr>
                                    <td>Energia Ativa Export</td>
                                    <td>${getTariffValue(activeEnergy, 'T1', 'EXPORT').value.toFixed(2)} kWh</td>
                                </tr>
                                <tr>
                                    <td>Energia Reativa Import</td>
                                    <td>${getTariffValue(reactiveEnergy, 'T1', 'IMPORT').value.toFixed(2)} kvarh</td>
                                </tr>
                                <tr>
                                    <td>Energia Reativa Export</td>
                                    <td>${getTariffValue(reactiveEnergy, 'T1', 'EXPORT').value.toFixed(2)} kvarh</td>
                                </tr>
                                <tr>
                                    <td>Energia Aparente</td>
                                    <td>${getTariffValue(apparentEnergy, 'T1', 'NET').value.toFixed(2)} kVAh</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="tariff-table">
                        <h3>Tarifa 2 (Fora de Ponta) ${actualTariff === 'T2' ? '<span class="tariff-active">ATIVA</span>' : ''}</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Valor (kWh/kvarh/kVAh)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Energia Ativa Import</td>
                                    <td>${getTariffValue(activeEnergy, 'T2', 'IMPORT').value.toFixed(2)} kWh</td>
                                </tr>
                                <tr>
                                    <td>Energia Ativa Export</td>
                                    <td>${getTariffValue(activeEnergy, 'T2', 'EXPORT').value.toFixed(2)} kWh</td>
                                </tr>
                                <tr>
                                    <td>Energia Reativa Import</td>
                                    <td>${getTariffValue(reactiveEnergy, 'T2', 'IMPORT').value.toFixed(2)} kvarh</td>
                                </tr>
                                <tr>
                                    <td>Energia Reativa Export</td>
                                    <td>${getTariffValue(reactiveEnergy, 'T2', 'EXPORT').value.toFixed(2)} kvarh</td>
                                </tr>
                                <tr>
                                    <td>Energia Aparente</td>
                                    <td>${getTariffValue(apparentEnergy, 'T2', 'NET').value.toFixed(2)} kVAh</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Adicionar informa√ß√µes de identifica√ß√£o (n√£o dispon√≠veis na resposta)
            html += `
                <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <h3 style="color: #4fc3f7; margin-bottom: 15px;">‚ÑπÔ∏è Identifica√ß√£o do Dispositivo</h3>
                    <div class="data-grid">
                        <div class="data-card">
                            <div class="card-title">Identifica√ß√£o na Planta</div>
                            <div class="card-value null-value">N/A</div>
                            <div class="card-min-max"><span>N√£o dispon√≠vel na resposta</span></div>
                        </div>
                        <div class="data-card">
                            <div class="card-title">Identifica√ß√£o Local</div>
                            <div class="card-value null-value">N/A</div>
                            <div class="card-min-max"><span>N√£o dispon√≠vel na resposta</span></div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // Fun√ß√£o para atualizar gr√°ficos
        function updateCharts(instantData) {
            if (!instantData || !instantData.INST_VALUES) return;
            
            const iv = instantData.INST_VALUES;
            const now = new Date().toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            // Atualizar dados de tens√£o
            voltageData.labels.push(now);
            ['V_L1', 'V_L2', 'V_L3'].forEach((phase, i) => {
                const value = getValue(iv, phase);
                voltageData.datasets[i].data.push(value);
            });
            
            // Atualizar dados de pot√™ncia
            powerData.labels.push(now);
            const pSum = getValue(iv, 'P_SUM');
            powerData.datasets[0].data.push(pSum);
            
            // Manter apenas MAX_DATA_POINTS no gr√°fico
            if (voltageData.labels.length > MAX_DATA_POINTS) {
                voltageData.labels.shift();
                voltageData.datasets.forEach(ds => ds.data.shift());
            }
            if (powerData.labels.length > MAX_DATA_POINTS) {
                powerData.labels.shift();
                powerData.datasets.forEach(ds => ds.data.shift());
            }
            
            // Atualizar gr√°ficos
            if (voltageChart) voltageChart.update('none');
            if (powerChart) powerChart.update('none');
        }
        
        // Inicializar gr√°ficos
        function initCharts() {
            const ctxVoltage = document.getElementById('voltageChart').getContext('2d');
            const ctxPower = document.getElementById('powerChart').getContext('2d');
            
            voltageChart = new Chart(ctxVoltage, {
                type: 'line',
                data: voltageData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Tens√£o (V)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tens√£o por Fase (V)',
                            color: '#4fc3f7',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
            
            powerChart = new Chart(ctxPower, {
                type: 'line',
                data: powerData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 500
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Pot√™ncia (kW)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Pot√™ncia Total (kW)',
                            color: '#4fc3f7',
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
        
        // Fun√ß√£o para gerar alertas
        function generateAlerts(extremeData, instantData, counterData) {
            const alerts = [];
            
            // 1. Verificar data do dispositivo
            if (extremeData && extremeData.EXTREME_VALUES && extremeData.EXTREME_VALUES.LOCAL_TIME) {
                const deviceDate = new Date(extremeData.EXTREME_VALUES.LOCAL_TIME);
                const now = new Date();
                const diffYears = now.getFullYear() - deviceDate.getFullYear();
                if (diffYears > 1) {
                    alerts.push({
                        type: 'critical',
                        title: 'Rel√≥gio do dispositivo desatualizado',
                        message: `O dispositivo est√° com data de ${deviceDate.getFullYear()} (diferen√ßa de ${diffYears} anos). Isso pode afetar a precis√£o dos registros.`
                    });
                }
            }
            
            // 2. Verificar frequ√™ncia (se dispon√≠vel)
            if (extremeData && extremeData.EXTREME_VALUES && extremeData.EXTREME_VALUES.FREQ) {
                const freq = extremeData.EXTREME_VALUES.FREQ;
                if (freq.max > 61 || freq.min < 59) {
                    alerts.push({
                        type: 'warning',
                        title: 'Frequ√™ncia fora da faixa ideal',
                        message: `Frequ√™ncia variando entre ${freq.min}Hz e ${freq.max}Hz. Ideal: 60Hz ¬±1Hz.`
                    });
                }
            }
            
            // 3. Verificar correntes zeradas
            if (extremeData && extremeData.EXTREME_VALUES) {
                const phases = ['I_L1', 'I_L2', 'I_L3'];
                const allZero = phases.every(phase => 
                    extremeData.EXTREME_VALUES[phase] && 
                    extremeData.EXTREME_VALUES[phase].max === 0 && 
                    extremeData.EXTREME_VALUES[phase].min === 0
                );
                
                if (allZero) {
                    alerts.push({
                        type: 'warning',
                        title: 'Correntes zeradas em todas as fases',
                        message: 'N√£o h√° consumo registrado. Verifique se h√° carga conectada ou se os transformadores de corrente (TCs) est√£o instalados.'
                    });
                }
            }
            
            // 4. Verificar tens√µes zeradas
            if (extremeData && extremeData.EXTREME_VALUES) {
                const voltages = ['V_L1', 'V_L2', 'V_L3'];
                const anyZero = voltages.some(phase => 
                    extremeData.EXTREME_VALUES[phase] && 
                    extremeData.EXTREME_VALUES[phase].max === 0
                );
                
                if (anyZero) {
                    alerts.push({
                        type: 'critical',
                        title: 'Tens√£o zerada em uma ou mais fases',
                        message: 'Isso indica falha na medi√ß√£o ou na alimenta√ß√£o. Verifique as conex√µes.'
                    });
                }
            }
            
            // 5. Verificar THD alto
            if (extremeData && extremeData.EXTREME_VALUES) {
                const thdPhases = ['THDV_L1', 'THDV_L2', 'THDV_L3'];
                const highThd = thdPhases.some(phase => 
                    extremeData.EXTREME_VALUES[phase] && 
                    extremeData.EXTREME_VALUES[phase].max > 5
                );
                
                if (highThd) {
                    alerts.push({
                        type: 'warning',
                        title: 'Distor√ß√£o Harm√¥nica de Tens√£o elevada',
                        message: 'THD acima de 5% pode indicar problemas na rede (harm√¥nicos).'
                    });
                }
            }
            
            // 6. Verificar pot√™ncia zerada
            if (instantData && instantData.INST_VALUES) {
                const pSum = getValue(instantData.INST_VALUES, 'P_SUM');
                if (pSum !== null && pSum === 0) {
                    alerts.push({
                        type: 'warning',
                        title: 'Pot√™ncia total zerada',
                        message: 'Consumo de energia est√° zero. Pode ser normal se n√£o houver carga, ou indicar problema de medi√ß√£o.'
                    });
                }
            }
            
            // 7. Verificar energia acumulada zerada (pode indicar contador parado)
            if (counterData && counterData.COUNTER) {
                const activeEnergy = counterData.COUNTER.ACTIVE_ENERGY || {};
                let totalEnergy = 0;
                ['T1', 'T2'].forEach(tariff => {
                    const importVal = getValue(activeEnergy, tariff, 'IMPORT');
                    const exportVal = getValue(activeEnergy, tariff, 'EXPORT');
                    if (importVal !== null) totalEnergy += importVal;
                    if (exportVal !== null) totalEnergy -= exportVal;
                });
                
                if (totalEnergy === 0) {
                    alerts.push({
                        type: 'warning',
                        title: 'Contador de energia zerado',
                        message: 'O contador n√£o registrou consumo algum. Pode ser normal em instala√ß√£o nova ou indica que o medidor n√£o est√° funcionando.'
                    });
                }
            }
            
            return alerts;
        }
        
        // Fun√ß√£o para fazer requisi√ß√£o
        async function fetchData(type) {
            const url = `${BASE_URL}?type=${type}&_=${Date.now()}`;
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                
                const response = await fetch(url, { 
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`Erro ao buscar ${type}:`, error);
                return null;
            }
        }
        
        // Fun√ß√£o para atualizar todos os dados
        async function updateAllData() {
            const now = new Date();
            lastUpdateSpan.textContent = now.toLocaleTimeString('pt-BR');
            
            // Atualizar EXTREME_VALUES
            const extremeData = await fetchData('EXTREME_VALUES');
            if (extremeData) {
                lastExtremeData = extremeData;
                extremeContent.innerHTML = processExtremeData(extremeData);
            } else {
                extremeContent.innerHTML = `
                    <div class="alert">
                        <div class="alert-title"><span class="alert-icon">‚ö†Ô∏è</span> Erro de conex√£o</div>
                        <p>N√£o foi poss√≠vel obter dados de valores extremos. Verifique se o dispositivo est√° ligado e acess√≠vel na rede.</p>
                    </div>
                `;
            }
            
            // Atualizar INST_VALUES
            const instantData = await fetchData('INST_VALUES');
            if (instantData) {
                lastInstantData = instantData;
                instantContent.innerHTML = processInstantData(instantData);
                // Atualizar gr√°ficos com os novos dados
                updateCharts(instantData);
            } else {
                instantContent.innerHTML = `
                    <div class="alert">
                        <div class="alert-title"><span class="alert-icon">‚ö†Ô∏è</span> Erro de conex√£o</div>
                        <p>N√£o foi poss√≠vel obter dados instant√¢neos.</p>
                    </div>
                `;
            }
            
            // Atualizar COUNTER (nova requisi√ß√£o)
            const counterData = await fetchData('COUNTER');
            if (counterData) {
                lastCounterData = counterData;
                energyContent.innerHTML = processCounterData(counterData);
            } else {
                energyContent.innerHTML = `
                    <div class="alert">
                        <div class="alert-title"><span class="alert-icon">‚ö†Ô∏è</span> Erro de conex√£o</div>
                        <p>N√£o foi poss√≠vel obter dados do contador de energia.</p>
                    </div>
                `;
            }
            
            // Atualizar alertas
            if (lastExtremeData || lastInstantData || lastCounterData) {
                const alerts = generateAlerts(lastExtremeData, lastInstantData, lastCounterData);
                if (alerts.length === 0) {
                    alertsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #4caf50;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">‚úÖ</div>
                            <h3>Todos os par√¢metros dentro da faixa normal</h3>
                            <p>Nenhum alerta ou anomalia detectada no momento.</p>
                        </div>
                    `;
                } else {
                    let alertsHtml = '';
                    alerts.forEach(alert => {
                        const alertClass = alert.type === 'critical' ? 'critical' : 'warning';
                        alertsHtml += `
                            <div class="alert" style="border-color: ${alert.type === 'critical' ? '#f44336' : '#ff9800'}; background: ${alert.type === 'critical' ? 'rgba(244, 67, 54, 0.2)' : 'rgba(255, 152, 0, 0.2)'};">
                                <div class="alert-title" style="color: ${alert.type === 'critical' ? '#f44336' : '#ff9800'};">
                                    <span class="alert-icon">${alert.type === 'critical' ? 'üî¥' : 'üü†'}</span>
                                    ${alert.title}
                                </div>
                                <p>${alert.message}</p>
                            </div>
                        `;
                    });
                    alertsContent.innerHTML = alertsHtml;
                }
            } else {
                alertsContent.innerHTML = '<p>Aguardando dados para an√°lise...</p>';
            }
            
            // Atualizar status
            if (extremeData && instantData && counterData) {
                statusDot.classList.remove('error');
                statusText.textContent = 'Conectado';
                statusText.style.color = '#4caf50';
            } else {
                statusDot.classList.add('error');
                statusText.textContent = 'Erro de conex√£o';
                statusText.style.color = '#f44336';
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar gr√°ficos
            initCharts();
            
            // Primeira atualiza√ß√£o
            updateAllData();
            
            // Configurar intervalo
            setInterval(updateAllData, UPDATE_INTERVAL);
            
            // Tentar reconectar se houver erro (ap√≥s 30 segundos)
            setTimeout(() => {
                if (statusDot.classList.contains('error')) {
                    updateAllData();
                }
            }, 30000);
        });
        
        // Adicionar handler para erros de fetch globais
        window.addEventListener('unhandledrejection', event => {
            console.error('Erro n√£o tratado:', event.reason);
        });
    </script>
</body>
</html>